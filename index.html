<!doctype html><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>PingTap — Retro Rally (fix center-line clip)</title>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
<style>
  :root{ --hud:rgba(15,18,28,.64); --accent:#ffd34d; --score:#ffe66d; --combo:#7be3ff; --sub:#d7d7d7; }
  html,body{margin:0;height:100%;background:#091427;color:#fff}
  body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",system-ui}
  #cv{position:fixed;inset:0;touch-action:manipulation;background:#091427}

  .hud{position:fixed;left:10px;right:10px;top:calc(10px + env(safe-area-inset-top,0px));
       display:grid;grid-template-columns:1fr 1fr;gap:10px;z-index:20;pointer-events:none}
  .pill{background:var(--hud);backdrop-filter: blur(3px);border-radius:18px;padding:8px 12px;min-width:0}
  .pill b{display:block;font:700 20px "DotGothic16",system-ui;text-shadow:2px 2px 0 rgba(0,0,0,.55)}
  .pill small{display:block;margin-top:2px;font:700 16px "DotGothic16",system-ui;color:var(--sub);text-shadow:1px 1px 0 rgba(0,0,0,.5)}
  #sc{color:var(--score)} #cm{color:var(--combo)}
  .bar{grid-column:1 / span 2; display:flex;justify-content:center}
  .bar .pill{width:100%;max-width:640px;text-align:center}
  .bar b{font:700 18px "DotGothic16",system-ui}

  .card{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
        gap:14px;background:rgba(0,0,0,.55);text-align:center;padding:18px;z-index:30}
  .ttl{font:700 42px "DotGothic16",system-ui;text-shadow:3px 3px 0 rgba(0,0,0,.6)}
  .lead{font:700 22px "DotGothic16",system-ui}
  .desc{font:700 18px "DotGothic16",system-ui;line-height:1.6}
  .best{margin-top:4px;font:700 18px "DotGothic16",system-ui;color:#b9ffa8;text-shadow:2px 2px 0 rgba(0,0,0,.5)}
  .btn{display:inline-grid;place-items:center;min-width:46px;height:46px;border-radius:18px;padding:0 18px;
       background:#ffd34d;color:#222;font-weight:800;box-shadow:0 4px 0 #caa132;border:0;font:700 20px "DotGothic16",system-ui}
</style>

<canvas id="cv"></canvas>

<div class="hud">
  <div class="pill"><b id="sc">Score 0</b><small id="scsub">&nbsp;</small></div>
  <div class="pill"><b id="cm">Combo 0</b><small id="cmsub">&nbsp;</small></div>
  <div class="bar"><div class="pill"><b id="lvtime">Lv.1　0:00</b></div></div>
</div>

<div class="card" id="start">
  <div class="ttl">レッツ！ピンポン！！</div>
  <div class="lead">ラリーを楽しもう</div>
  <div class="desc">円が重なる瞬間に <b>TAP!</b></div>
  <div class="desc">Perfect / Great / Good で加点＆コンボ。<br>90秒で<strong>激ムズモード</strong>。</div>
  <div id="bestStart" class="best">Best 0</div>
  <button id="go" class="btn">スタート</button>
</div>

<div class="card" id="over" style="display:none">
  <div id="final" class="ttl" style="font-size:36px">Score 0<br>Lv.1</div>
  <button id="retry" class="btn">もう一回</button>
</div>

<script>
(()=>{
// ===== 画像 =====
const BG_URL='./F0BDAD6E-3A4B-49E8-86BF-73CE3EAA6C58.png';
const FG_URL='./IMG_4406.png';
const OPP_IDLE='./IMG_4414.png', OPP_SWING='./IMG_4413.png', OPP_FOLLOW='./IMG_4412.png';

// ===== パラメータ =====
const NET_Y=0.595, Y_PLAYER=0.115, Y_OPP=0.085, X_MARGIN=0.16, Y_JIT=0.018;
const START_DUR=1.00, SPEEDUP_EVERY=2, SPEEDUP_RATE=0.93, MIN_DUR=0.46, DEMON_AT=90;
const RING_BASE=28, RING_SHRINK=36;
const TOL_DIST_GOOD=36, TOL_DIST_GREAT=22, TOL_DIST_PERF=12;
const TOL_TIME_GOOD=12, TOL_TIME_GREAT=7,  TOL_TIME_PERF=3;
const SCORE_BASE=100, MULT_GOOD=1.00, MULT_GREAT=1.30, MULT_PERF=1.60;
const COMBO_BONUS=0.15, ARC_H=0.12, CURVE_X=0.10;

const BG_DES_W=768, BG_DES_H=1152; let FG_SCALE=0.92, FG_Y_OFFSET=0;
const OPP_BASE_SCALE=0.58*1.35, OPP_FOOT_Y=0.565; const BALL_FRONT=true;

// ===== 透け対策（位置再キャリブレーション） =====
const OCC_COLOR='#0b213c';
// ネットの格子帯（不透明で覆う）
const OCC_A = {x:0.030, y:0.472, w:0.940, h:0.108};
// ネット上の薄帯（念のため）
const OCC_B = {x:0.030, y:0.438, w:0.940, h:0.036};
// 自陣ハーフ卓面（センター線クリップ用）
const TABLE_HALF = {x:0.070, y:0.607, w:0.860, h:0.128};
const CENTER_X_NORM=0.500;

// ===== DOM =====
const cv=document.getElementById('cv'), g=cv.getContext('2d');
const S=document.getElementById('start'), O=document.getElementById('over');
const go=document.getElementById('go'), retry=document.getElementById('retry');
const sc=document.getElementById('sc'), scs=document.getElementById('scsub');
const cm=document.getElementById('cm'), cms=document.getElementById('cmsub');
const lvtime=document.getElementById('lvtime'), fin=document.getElementById('final'), bestStart=document.getElementById('bestStart');
let W=0,H=0,dpr=1; function fit(){ dpr=Math.max(1,Math.min(3,devicePixelRatio||1));
  W=innerWidth; H=innerHeight; cv.width=W*dpr; cv.height=H*dpr; cv.style.width=W+'px'; cv.style.height=H+'px'; g.setTransform(dpr,0,0,dpr,0,0);
} addEventListener('resize',fit,{passive:true}); fit();

// ===== 画像ロード =====
const load=s=>new Promise(r=>{const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>r(i); i.onerror=()=>r(null); i.src=s; });
const A={}; Promise.all([load(BG_URL),load(FG_URL),load(OPP_IDLE),load(OPP_SWING),load(OPP_FOLLOW)])
 .then(([bg,fg,oi,os,of])=>{A.bg=bg;A.fg=fg;A.oi=oi;A.os=os;A.of=of;});

// ===== Audio（現行の良い感じそのまま） =====
let AC=null, master=null, mGain=null, sfx=null, loopTimer=null, tempo=124;
function ensureAC(){ if(!AC){ AC=new (window.AudioContext||window.webkitAudioContext)();
  master=AC.createGain(); master.gain.value=.9; master.connect(AC.destination);
  mGain=AC.createGain(); mGain.gain.value=0.2; mGain.connect(master);
  sfx=AC.createGain(); sfx.gain.value=0.22; sfx.connect(master);
}}
function sePock(freq=1350,t=0.12){ ensureAC(); const o=AC.createOscillator(), g=AC.createGain();
  o.type='square'; o.frequency.setValueAtTime(freq,AC.currentTime);
  o.frequency.exponentialRampToValueAtTime(520,AC.currentTime+0.06);
  g.gain.setValueAtTime(0.0001,AC.currentTime);
  g.gain.exponentialRampToValueAtTime(0.28,AC.currentTime+0.006);
  g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+t);
  o.connect(g).connect(sfx); o.start(); o.stop(AC.currentTime+t+0.02);
}
function startBGM(){
  ensureAC(); stopBGM();
  const delay=AC.createDelay(0.28), fb=AC.createGain(); delay.delayTime.value=0.22; fb.gain.value=0.26; delay.connect(fb).connect(delay); delay.connect(mGain);
  function tone(f,when,len,vol=0.18,type='square'){ const o=AC.createOscillator(), g=AC.createGain(); o.type=type; o.frequency.value=f;
    g.gain.setValueAtTime(0,when); g.gain.linearRampToValueAtTime(vol,when+0.01); g.gain.exponentialRampToValueAtTime(0.0001,when+len);
    o.connect(g); g.connect(delay); g.connect(mGain); o.start(when); o.stop(when+len+0.05);
  }
  loopTimer=setInterval(()=>{
    if(!AC||AC.state!=='running') return;
    const beat=60/tempo, now=AC.currentTime+0.04;
    const arp=[[261.6,329.6,392.0],[349.2,440.0,523.3],[392.0,493.9,587.3],[440.0,523.3,659.3]];
    for(let c=0;c<4;c++){ const a=arp[c]; for(let i=0;i<4;i++){ tone(a[i%3], now+(c*4+i)*(beat/2), beat*0.40, 0.2, 'square'); } }
    const bass=[130.8,174.6,196.0,220.0]; for(let i=0;i<4;i++){ tone(bass[i], now+i*beat, beat*0.9, 0.14,'triangle'); }
    const mkHat=(t)=>{const n=AC.createBufferSource(), b=AC.createBuffer(1,2000,AC.sampleRate), d=b.getChannelData(0);
      for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*(1-i/d.length); } n.buffer=b; const g=AC.createGain(); g.gain.value=0.03; n.connect(g).connect(mGain); n.start(t); };
    for(let k=0.25;k<4;k+=0.5) mkHat(now+beat*k);
  }, Math.max(120, 1000*4*(60/tempo)));
}
function stopBGM(){ if(loopTimer){clearInterval(loopTimer); loopTimer=null;} }
function speedUpBGM(lv){ tempo=Math.min(172, 124 + lv*3); }

// ===== 補助 =====
const R=Math.random, rnd=(a,b)=>a+R()*(b-a), sec=()=>performance.now()/1000;
const oppSpot=()=>({x:rnd(W*X_MARGIN,W*(1-X_MARGIN)), y:H*NET_Y-H*Y_OPP+rnd(-H*Y_JIT,H*Y_JIT)});
const plySpot=()=>({x:rnd(W*X_MARGIN,W*(1-X_MARGIN)), y:H*NET_Y+H*Y_PLAYER+rnd(-H*Y_JIT,H*Y_JIT)});
const bez=(p,a,c,b)=>{const u=1-p; return u*u*a+2*u*p*c+p*p*b;};

// ===== 状態 =====
let playing=false, t0=0, dur=START_DUR, phase='toPlayer';
let from={x:0,y:0}, to={x:0,y:0}, ctrl={x:0,y:0};
let playerAim={x:0,y:0}, oppAim={x:0,y:0};
let score=0, combo=0, best=+(localStorage.getItem('PT_best')||0), level=1, steps=0, startedAt=0;
let judgeText='', judgeUntil=0, judgeColor='#ffe38a';
bestStart.textContent='Best '+best;

function setLeg(a,b){ from=a;to=b;t0=sec(); const midx=(a.x+b.x)/2, curve=(b.x-a.x)*rnd(-0.10,0.10);
  ctrl={x:midx+curve, y:H*NET_Y - H*ARC_H*rnd(0.85,1.15)}; }

function updateLvTime(){ const t=Math.max(0,Math.floor(sec()-startedAt)); const mm=String(Math.floor(t/60)); const ss=String(t%60).padStart(2,'0');
  lvtime.textContent=`Lv.${level}　${mm}:${ss}`; }

function resetState(){
  score=0; combo=0; steps=0; level=1; dur=START_DUR; startedAt=sec();
  sc.textContent='Score 0'; scs.innerHTML='&nbsp;'; cm.textContent='Combo 0'; cms.innerHTML='&nbsp;'; cms.style.color='var(--sub)';
  playerAim=plySpot(); oppAim=oppSpot(); phase='toPlayer'; setLeg(oppAim,playerAim); judgeText=''; judgeUntil=0; judgeColor='#ffe38a';
  updateLvTime(); speedUpBGM(level);
}

function startGame(){ ensureAC(); startBGM(); resetState(); S.style.display='none'; O.style.display='none'; playing=true; }
function gameOver(){ playing=false; stopBGM();
  if(score>best){ best=score; localStorage.setItem('PT_best',best); }
  bestStart.textContent='Best '+best; fin.innerHTML=`Score ${score}<br>Lv.${level}`; O.style.display='flex';
}

// ===== 入力 =====
addEventListener('pointerdown',e=>{
  if(AC && AC.state==='suspended'){ AC.resume(); }
  if(!playing||phase!=='toPlayer') return;
  const r=cv.getBoundingClientRect(), x=(e.clientX??e.touches?.[0]?.clientX)-r.left, y=(e.clientY??e.touches?.[0]?.clientY)-r.top;
  const rr=ringRadiusNow(), dt=Math.abs(rr-RING_BASE), d=Math.hypot(x-playerAim.x,y-playerAim.y);
  let mult=0, tag=''; if(dt<=3 && d<=12){mult=MULT_PERF;tag='PERFECT!';judgeColor='#ff6b6b';}
  else if(dt<=7 && d<=22){mult=MULT_GREAT;tag='GREAT!';judgeColor='#7bdcff';}
  else if(dt<=12 && d<=36){mult=MULT_GOOD;tag='GOOD!';judgeColor='#ffe38a';}
  if(mult>0){
    sePock(1400,0.12);
    const add=Math.round(SCORE_BASE*mult*(1+combo*COMBO_BONUS));
    score+=add; combo++; steps++; sc.textContent='Score '+score; scs.textContent='+'+add; cm.textContent='Combo '+combo; cms.textContent=tag; cms.style.color=judgeColor;
    judgeText=tag; judgeUntil=sec()+0.85;
    if(steps%SPEEDUP_EVERY===0){ const elapsed=sec()-startedAt; dur=Math.max(MIN_DUR, dur*((elapsed>=DEMON_AT)?0.90:SPEEDUP_RATE)); level++; speedUpBGM(level); updateLvTime(); }
    phase='toOpponent'; oppAim=oppSpot(); setLeg(playerAim,oppAim);
  }else{ cms.textContent='Miss!'; cms.style.color='#ffd0d0'; judgeText='Miss!'; judgeUntil=sec()+0.85; gameOver(); }
},{passive:true});

function ringRadiusNow(){ const p=Math.min(1,Math.max(0,(sec()-t0)/dur)); return RING_BASE+RING_SHRINK*((phase==='toPlayer')?(1-p):1); }

// ===== ループ =====
function loop(){
  const now=sec();
  if(A.bg){ const r=Math.max(W/A.bg.width,H/A.bg.height), w=A.bg.width*r, h=A.bg.height*r; g.drawImage(A.bg,(W-w)/2,(H-h)/2,w,h); }
  else{ const grd=g.createLinearGradient(0,0,0,H); grd.addColorStop(0,'#1a315d'); grd.addColorStop(1,'#0b1631'); g.fillStyle=grd; g.fillRect(0,0,W,H); }

  drawOpponent(now);
  hardOcclude();     // ← 先に塗って完全不透明化
  drawForeground();  // ← 台＋ネット画像を最後に

  if(playing){
    const p=Math.min(1,(now-t0)/dur), bx=bez(p,from.x,ctrl.x,to.x), by=bez(p,from.y,ctrl.y,to.y);
    if(phase==='toOpponent' && p<0.02){ sePock(900,0.10); } // 相手ヒット音
    if(p>=1){ if(phase==='toPlayer') gameOver(); else { phase='toPlayer'; playerAim=plySpot(); setLeg(oppAim,playerAim);} }
    drawGuide(playerAim.x,playerAim.y,ringRadiusNow(),true,(judgeUntil>now)?judgeText:'TAP!', (judgeUntil>now)?judgeColor:'#ffe38a');
    updateLvTime();
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// ===== 前景 =====
function drawForeground(){ if(!A.fg) return;
  const sBase=Math.min(W/BG_DES_W,H/BG_DES_H), s=sBase*FG_SCALE;
  const w=A.fg.width*s, h=A.fg.height*s, x=Math.round((W-w)/2), y=Math.round(H-h+FG_Y_OFFSET*s);
  const keep=g.imageSmoothingEnabled; g.imageSmoothingEnabled=false; g.drawImage(A.fg,x,y,w,h); g.imageSmoothingEnabled=keep;
}

// ===== オクルード＆センター線（卓面だけにクリップ） =====
function hardOcclude(){ if(!A.fg) return;
  const sBase=Math.min(W/BG_DES_W,H/BG_DES_H), s=sBase*FG_SCALE;
  const fw=A.fg.width*s, fh=A.fg.height*s, fx=Math.round((W-fw)/2), fy=Math.round(H-fh+FG_Y_OFFSET*s);

  // ネット周りを完全不透明で覆う
  g.save(); g.globalAlpha=1; g.fillStyle=OCC_COLOR;
  g.fillRect(fx+OCC_A.x*fw, fy+OCC_A.y*fh, OCC_A.w*fw, OCC_A.h*fh);
  g.fillRect(fx+OCC_B.x*fw, fy+OCC_B.y*fh, OCC_B.w*fw, OCC_B.h*fh);

  // 自陣ハーフだけをクリップ → その中に白いセンター線
  const tx=fx+TABLE_HALF.x*fw, ty=fy+TABLE_HALF.y*fh, tw=TABLE_HALF.w*fw, th=TABLE_HALF.h*fh;
  g.beginPath(); g.rect(tx,ty,tw,th); g.clip();
  const cx=fx+CENTER_X_NORM*fw;
  g.fillStyle='#ffffff';
  g.fillRect(cx-1.2, ty+th*0.06, 2.4, th*0.88); // 上下に余白、床側へは出ない
  g.restore();
}

// ===== 相手 =====
function drawOpponent(now){
  if(!A.oi) return; const sBase=Math.min(W/BG_DES_W,H/BG_DES_H), scale=sBase*OPP_BASE_SCALE;
  let img=A.oi; if(playing && phase==='toOpponent'){ const p=Math.min(1,(now-t0)/dur); if(p>0.65&&p<=0.8) img=A.os; else if(p>0.8&&p<=0.95) img=A.of; }
  const faceRight=(oppAim.x<W*0.5), iw=img.width*scale, ih=img.height*scale, cx=oppAim.x, x=cx-iw*0.5, y=H*OPP_FOOT_Y-ih;
  g.save(); if(!faceRight){ g.translate(cx,0); g.scale(-1,1); g.translate(-cx,0); }
  const keep=g.imageSmoothingEnabled; g.imageSmoothingEnabled=false; g.drawImage(img, faceRight?x:(2*cx-x-iw), Math.round(y), Math.round(iw), Math.round(ih)); g.imageSmoothingEnabled=keep; g.restore();
}

// ===== ガイド（色可変） =====
function drawGuide(x,y,rr,isPlayer,label,labelColor){
  g.beginPath(); g.lineWidth=3; g.setLineDash([]); g.strokeStyle=isPlayer?'rgba(255,235,150,.95)':'rgba(170,220,255,.92)'; g.arc(x,y,RING_BASE,0,Math.PI*2); g.stroke();
  g.beginPath(); g.lineWidth=3; g.setLineDash(isPlayer?[6,6]:[]); g.strokeStyle=isPlayer?'rgba(255,235,150,.95)':'rgba(170,220,255,.92)'; g.arc(x,y,rr,0,Math.PI*2); g.stroke(); g.setLineDash([]);
  g.fillStyle=labelColor||'#ffe38a'; g.font='700 16px DotGothic16,system-ui'; g.textAlign='center'; g.fillText(label, x, y-RING_BASE-12);
}

// ===== UI =====
go.onclick=()=>{ ensureAC(); startBGM(); startGame(); };
retry.onclick=()=>{ S.style.display='flex'; O.style.display='none'; };

})();
</script>