<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>PingTap — Retro Rally</title>
<style>
  :root{ --hud-gap:10px; --cap-bg:rgba(0,0,0,.35); --cap-blur:saturate(120%) blur(6px); --accent:#ffd14a;}
  html,body{height:100%;margin:0;background:#0b1224;color:#fff;font:16px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Sans",Meiryo,sans-serif;}
  .stage{position:fixed;inset:0;background:#0b1224 url("./2FE72969-9374-4D85-ADBC-28EADEE8437A.png?v=3") center/cover no-repeat}
  .stage.fallback{background:#0b1224}
  .shade{position:fixed;inset:0;background:radial-gradient(120% 120% at 50% 20%,transparent 60%,rgba(0,0,0,.45));pointer-events:none}
  canvas{position:fixed;inset:0;touch-action:none} /* ←Safariでのジェスチャ誤認防止 */
  .hud{position:fixed;top:calc(env(safe-area-inset-top,0px)+6px);left:calc(env(safe-area-inset-left,0px)+8px);right:calc(env(safe-area-inset-right,0px)+8px);display:grid;grid-template-columns:auto auto 1fr auto auto;gap:var(--hud-gap);align-items:center;z-index:10;pointer-events:none}
  .cap{background:var(--cap-bg);backdrop-filter:var(--cap-blur);color:#fff;font-weight:700;padding:8px 14px;border-radius:20px;white-space:nowrap;line-height:1;text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .spacer{min-width:6px}
  .btn{pointer-events:auto;cursor:pointer;border:0;font:inherit;color:#fff}
  .btn.pill{background:var(--cap-bg);backdrop-filter:var(--cap-blur);padding:8px 14px;border-radius:20px}
  .center{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;z-index:9}
  .center .msg{pointer-events:auto;text-align:center}
  .big{font-size:28px;font-weight:800;text-shadow:0 2px 0 rgba(0,0,0,.5)}
  .btn.main{background:var(--accent);color:#221;padding:12px 22px;border-radius:14px;margin-top:12px}
  .overlay{position:fixed;inset:0;display:none;place-items:center;z-index:20}
  .overlay.show{display:grid}
  .panel{background:rgba(10,12,20,.9);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;width:min(92vw,420px)}
  .panel h2{margin:0 0 12px;font-size:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row .btn{background:#243048;padding:10px 14px;border-radius:10px}
  .note{opacity:.75;font-size:12px;margin-top:8px}
  .guide{position:fixed;left:0;top:0;pointer-events:none;z-index:8}
  .hint{position:absolute;transform:translate(-50%,-50%);text-align:center;color:#ffe07a;font-weight:800;letter-spacing:.03em}
  .ring{width:1px;height:1px;border-radius:999px;border:3px dashed #ffd96b;box-shadow:0 0 0 3px rgba(255,217,107,.25) inset,0 0 18px rgba(255,217,107,.25)}
  .dot{width:10px;height:10px;background:#ffe07a;border-radius:999px;margin:10px auto 0}
  .foot{position:fixed;left:0;right:0;bottom:calc(env(safe-area-inset-bottom,0px)+6px);text-align:center;font-size:12px;opacity:.65;pointer-events:none}
</style>

<div class="stage" id="bg"></div>
<div class="shade"></div>
<canvas id="cv"></canvas>

<div class="hud">
  <div id="score" class="cap">Score 0</div>
  <div id="combo" class="cap">Combo 0</div>
  <div class="spacer"></div>
  <div id="best"  class="cap">Best 0 / Lv.1</div>
  <button id="pause" class="btn pill" aria-label="Pause">II</button>
</div>

<div class="guide" id="guide">
  <div class="hint" id="hint" style="left:-9999px;top:-9999px">
    <div id="hintText">TAP!</div>
    <div class="ring" id="ring"></div>
    <div class="dot"></div>
  </div>
</div>

<div class="center" id="center">
  <div class="msg">
    <div class="big" id="centerText">PingTap — Retro Rally</div>
    <button id="startBtn" class="btn main">スタート</button>
  </div>
</div>

<div class="overlay" id="menu">
  <div class="panel">
    <h2>Pause</h2>
    <div class="row">
      <button class="btn" id="resumeBtn">▶ 再開</button>
      <button class="btn" id="restartBtn">↻ リスタート</button>
      <button class="btn" id="bgmBtn">♪ BGM ON/OFF</button>
    </div>
    <div class="note">中断時も状態保持。再開は即時。</div>
  </div>
</div>

<div class="foot">※ ラリーは最大90秒で鬼加速。Good/Great/Perfectで加点＆コンボ。</div>

<script>
/* ===== 調整用定数 ===== */
const CFG = {
  TARGET_Y_FRAC: 0.63, PLAYER_X_RANGE: 0.32, ENEMY_X_RANGE: 0.38,
  RING_BASE: 58, TOL_GOOD: 22, TOL_GREAT: 14, TOL_PERF: 8,
  SPEED_MS_START: 1150, SPEED_MS_END: 450, HITS_TO_MAX: 70, POST_90_ACCEL: 0.85,
  BALL_ARC_H: 0.12, SFX_VOL: 0.35,
};
/* ====================== */

const cv = document.getElementById('cv'), g = cv.getContext('2d');
const guide = document.getElementById('guide'), hint = document.getElementById('hint'),
      ringEl = document.getElementById('ring'), hintText = document.getElementById('hintText');
const center = document.getElementById('center'), centerText = document.getElementById('centerText'), startBtn = document.getElementById('startBtn');
const scoreEl = document.getElementById('score'), comboEl = document.getElementById('combo'), bestEl = document.getElementById('best');
const pauseBtn = document.getElementById('pause'), menu = document.getElementById('menu'),
      resumeBtn = document.getElementById('resumeBtn'), restartBtn = document.getElementById('restartBtn'), bgmBtn = document.getElementById('bgmBtn');

let W=0,H=0,DPR=1, RAF=0, now=0, last=0;
let state='idle';
let round=0, score=0, best=Number(localStorage.getItem('pingtap_best')||0)|0, combo=0, level=1;
let ring={x:0,y:0,r:CFG.RING_BASE,rMax:CFG.RING_BASE,t:0,dur:CFG.SPEED_MS_START};
let ball=null, travel=null, post90=1;

/* ---- レイアウト ---- */
function rs(){
  DPR=Math.min(2,(window.devicePixelRatio||1));
  W=cv.width=Math.floor(innerWidth*DPR); H=cv.height=Math.floor(innerHeight*DPR);
  cv.style.width=innerWidth+'px'; cv.style.height=innerHeight+'px';
  guide.style.width=innerWidth+'px'; guide.style.height=innerHeight+'px';
}
addEventListener('resize', rs, {passive:true}); rs();

/* ---- 背景フォールバック ---- */
(()=>{ const img=new Image(); img.onerror=()=>document.getElementById('bg').classList.add('fallback'); img.src="./2FE72969-9374-4D85-ADBC-28EADEE8437A.png?v=3"; })();

/* ---- 音 ---- */
const AC = new (window.AudioContext||window.webkitAudioContext)();
let bgmSeq=null, bgmOn=false;
function sTap(kind='good'){ const t=AC.currentTime,v=AC.createGain();v.gain.value=CFG.SFX_VOL;v.connect(AC.destination);
  const o=AC.createOscillator();o.type='square';const base=kind==='perfect'?880:kind==='great'?740:660;
  o.frequency.setValueAtTime(base,t); o.frequency.exponentialRampToValueAtTime(base*0.7,t+0.06);
  v.gain.exponentialRampToValueAtTime(0.0001,t+0.08); o.connect(v); o.start(); o.stop(t+0.09);
}
function sMiss(){ const t=AC.currentTime,v=AC.createGain();v.gain.value=CFG.SFX_VOL*0.9;v.connect(AC.destination);
  const a=AC.createOscillator(),b=AC.createOscillator(); a.type=b.type='triangle';
  a.frequency.value=240; b.frequency.value=180; v.gain.exponentialRampToValueAtTime(0.0001,t+0.4);
  a.connect(v); b.connect(v); a.start(); b.start(); a.stop(t+0.41); b.stop(t+0.41);
}
function startBGM(){ if(bgmSeq) return; const m=AC.createGain(); m.gain.value=0.18; m.connect(AC.destination);
  function ch(type,notes,tempo=110){ let g=AC.createGain(); g.gain.value=0.8; g.connect(m); let o=AC.createOscillator(); o.type=type; o.connect(g);
    let t=AC.currentTime+0.02, sp=60/tempo; for(let i=0;i<128;i++){ const n=notes[i%notes.length]; const f=440*Math.pow(2,(n-69)/12);
      o.frequency.setValueAtTime(f,t); g.gain.setValueAtTime(0.9,t); g.gain.exponentialRampToValueAtTime(0.001,t+sp*0.8); t+=sp; }
    o.start(); return {o,g}; }
  const lead=ch('square',[76,79,83,79,76,79,83,79],112); const bass=ch('triangle',[40,40,43,40,35,35,38,35],56);
  bgmSeq={m,lead,bass}; bgmOn=true;
}
function stopBGM(){ if(!bgmSeq) return; ['lead','bass'].forEach(k=>{try{bgmSeq[k].o.stop()}catch{}}); bgmSeq.m.disconnect(); bgmSeq=null; bgmOn=false; }

/* ---- ユーティリティ ---- */
const easeInOut=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
function updateHUD(){ scoreEl.textContent=`Score ${score|0}`; comboEl.textContent=`Combo ${combo|0}`; bestEl.textContent=`Best ${Math.max(best,score)|0} / Lv.${level|0}`; }
function showHint(show){ if(!show){ hint.style.left='-9999px'; hint.style.top='-9999px'; return; } hint.style.left=ring.x+'px'; hint.style.top=ring.y+'px'; }

/* ---- 配置 ---- */
function placeNextTarget(){ const cx=innerWidth*0.5;
  ring.x = cx + (Math.random()*2-1)*innerWidth*CFG.PLAYER_X_RANGE*0.5;
  ring.y = innerHeight*CFG.TARGET_Y_FRAC; ring.r=ring.rMax=CFG.RING_BASE; ring.t=0;
  ringEl.style.width=(ring.r*2)+'px'; ringEl.style.height=(ring.r*2)+'px';
  if(state==='play') showHint(true);
}
function scheduleEnemyReturn(){
  const sx=ring.x, sy=ring.y;
  const ex=innerWidth*0.5 + (Math.random()*2-1)*innerWidth*CFG.ENEMY_X_RANGE*0.5, ey=innerHeight*0.28;
  const nx=ring.x, ny=ring.y, T=Math.max(350, ring.dur*0.6);
  travel={phase:0,sx,sy,ex,ey,nx,ny,t:0,dur:T}; ball={x:sx,y:sy};
}

/* ---- ステート管理 ---- */
function resetAll(){
  cancelAnimationFrame(RAF); RAF=0;
  score=0; combo=0; level=1; round=0; post90=1;
  ball=null; travel=null;
  ring.r=ring.rMax=CFG.RING_BASE; ring.t=0; ring.dur=CFG.SPEED_MS_START;
  updateHUD(); centerText.textContent='Score 0 / Lv.1'; startBtn.textContent='もう一回';
  state='idle'; showHint(false); placeNextTarget(); draw();
}
function startGame(){
  AC.resume().catch(()=>{}); center.style.display='none'; menu.classList.remove('show');
  state='play'; last=performance.now(); showHint(true);
  if(!RAF) RAF=requestAnimationFrame(loop);
}
function commitHit(grade){
  const add = grade==='perfect'?300:grade==='great'?200:120;
  combo++; const mult=1+Math.min(2,combo*0.04); score += Math.round(add*mult);
  if(score>best){ best=score; localStorage.setItem('pingtap_best', best|0); }
  round++; const p=Math.min(1, round/CFG.HITS_TO_MAX);
  ring.dur = CFG.SPEED_MS_START + (CFG.SPEED_MS_END-CFG.SPEED_MS_START)*p;
  if(p>=1){ ring.dur=Math.max(300, ring.dur*CFG.POST_90_ACCEL**(round-CFG.HITS_TO_MAX)); }
  level = 1 + Math.floor(round/10); updateHUD(); sTap(grade);
  scheduleEnemyReturn(); placeNextTarget();
}
function miss(){
  sMiss(); state='over'; showHint(false); ball=null; travel=null;
  center.style.display='grid'; centerText.textContent=`Score ${score|0} / Lv.${level|0}`; startBtn.textContent='もう一回'; combo=0; updateHUD();
}

/* ---- 入力 ---- */
function tap(){
  if(state==='idle' || state==='over'){ // どこをタップしても開始/再開
    resetAll(); startGame(); return;
  }
  if(state!=='play') return;
  const tErr=Math.abs(ring.t-ring.dur*0.5);
  let grade=null; if(tErr<=CFG.TOL_PERF) grade='perfect'; else if(tErr<=CFG.TOL_GREAT) grade='great'; else if(tErr<=CFG.TOL_GOOD) grade='good'; else return miss();
  commitHit(grade);
}
addEventListener('pointerdown', e=>{ e.preventDefault(); tap(); }, {passive:false});

/* ---- 進行 ---- */
function loop(ts){ RAF=requestAnimationFrame(loop); now=ts; const dt=now-last; last=now; update(dt); draw(); }
function update(dt){
  if(state!=='play') return;
  if(travel){
    const T=travel; T.t+=dt; const u=Math.min(1,T.t/T.dur), v=easeInOut(u), h=innerHeight*CFG.BALL_ARC_H;
    if(T.phase===0){ ball.x=T.sx+(T.ex-T.sx)*v; ball.y=(T.sy+(T.ey-T.sy)*v)-Math.sin(Math.PI*v)*h; if(u>=1){T.phase=1;T.t=0;} }
    else{ ball.x=T.ex+(T.nx-T.ex)*v; ball.y=(T.ey+(T.ny-T.ey)*v)-Math.sin(Math.PI*v)*h; if(u>=1){ travel=null; } }
  }else{
    ring.t+=dt; const prog=Math.min(1, ring.t/ring.dur);
    ring.r=ring.rMax*(1-0.6*prog); ringEl.style.width=(ring.r*2)+'px'; ringEl.style.height=(ring.r*2)+'px';
    hintText.textContent= prog<0.35?'TAP!':'HIT!';
    if(ring.t>ring.dur+CFG.TOL_GOOD) miss();
    if(!ball){ ball={x:ring.x, y:ring.y-innerHeight*0.22}; }
    ball.y = ring.y - innerHeight*(0.22*(1 - Math.min(1,prog))); ball.x += (ring.x-ball.x)*0.15;
  }
}
function draw(){
  g.clearRect(0,0,W,H);
  if(ball){ const r=8*DPR; g.fillStyle='#ffe07a'; g.beginPath(); g.arc(ball.x*DPR,ball.y*DPR,r,0,Math.PI*2); g.fill(); g.strokeStyle='rgba(0,0,0,.35)'; g.lineWidth=1*DPR; g.stroke(); }
}

/* ---- ポーズ ---- */
pauseBtn.addEventListener('click', ()=>{ if(state!=='play') return; state='pause'; menu.classList.add('show'); stopBGM(); });
resumeBtn.addEventListener('click', ()=>{ menu.classList.remove('show'); if(state==='pause'){ state='play'; last=performance.now(); if(!RAF) RAF=requestAnimationFrame(loop); if(bgmOn) startBGM(); }});
restartBtn.addEventListener('click', ()=>{ menu.classList.remove('show'); resetAll(); startGame(); });
bgmBtn.addEventListener('click', ()=>{ if(bgmSeq) stopBGM(); else startBGM(); });
document.addEventListener('visibilitychange', ()=>{ if(document.hidden && state==='play') pauseBtn.click(); });

/* ---- ボタン ---- */
startBtn.addEventListener('click', ()=>{ resetAll(); startGame(); });

/* 初期化 */
updateHUD(); showHint(false); placeNextTarget(); draw();
</script>