<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>PingTap — Retro Rally</title>
<style>
  :root{ --cap:rgba(0,0,0,.35); --blur:saturate(120%) blur(6px); --accent:#ffd14a}
  html,body{height:100%;margin:0;background:#0b1224;color:#fff;font:16px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Sans",Meiryo,sans-serif}
  .bg{position:fixed;inset:0;background:url("./2FE72969-9374-4D85-ADBC-28EADEE8437A.png?v=4") center/cover no-repeat}
  .shade{position:fixed;inset:0;background:radial-gradient(110% 110% at 50% 20%,transparent 60%,rgba(0,0,0,.45)) ;pointer-events:none}
  canvas{position:fixed;inset:0;touch-action:none}
  .hud{position:fixed;left:calc(env(safe-area-inset-left,0px)+8px);right:calc(env(safe-area-inset-right,0px)+8px);top:calc(env(safe-area-inset-top,0px)+6px);display:grid;grid-template-columns:auto auto 1fr auto;gap:10px;z-index:10;pointer-events:none}
  .cap{background:var(--cap);backdrop-filter:var(--blur);padding:8px 14px;border-radius:20px;font-weight:700;line-height:1;pointer-events:auto}
  .btn{cursor:pointer;border:0;background:var(--cap);backdrop-filter:var(--blur);color:#fff;border-radius:20px;padding:8px 14px}
  .center{position:fixed;inset:0;display:grid;place-items:center;z-index:9;pointer-events:none}
  .center > div{pointer-events:auto;text-align:center}
  .big{font-size:28px;font-weight:800;text-shadow:0 2px 0 rgba(0,0,0,.5)}
  .main{background:var(--accent);color:#221;padding:12px 22px;border-radius:14px;margin-top:12px;border:0}
  .hint{position:fixed;left:-9999px;top:-9999px;transform:translate(-50%,-50%);text-align:center;color:#ffe07a;font-weight:800;letter-spacing:.03em;z-index:8;pointer-events:none}
  .ring{width:1px;height:1px;border-radius:999px;border:3px dashed #ffd96b;box-shadow:0 0 0 3px rgba(255,217,107,.25) inset,0 0 18px rgba(255,217,107,.25)}
  .dot{width:10px;height:10px;background:#ffe07a;border-radius:999px;margin:10px auto 0}
  .overlay{position:fixed;inset:0;display:none;place-items:center;z-index:20}
  .overlay.show{display:grid}
  .panel{background:rgba(10,12,20,.9);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;width:min(92vw,420px)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row .btn{background:#243048;border-radius:10px}
</style>

<div class="bg" id="bg"></div>
<div class="shade"></div>
<canvas id="cv"></canvas>

<div class="hud">
  <div id="score" class="cap">Score 0</div>
  <div id="combo" class="cap">Combo 0</div>
  <div></div>
  <button id="pause" class="btn" aria-label="Pause">II</button>
</div>

<div class="hint" id="hint">
  <div id="hintText">TAP!</div>
  <div id="ring" class="ring"></div>
  <div class="dot"></div>
</div>

<div class="center" id="center">
  <div>
    <div id="centerText" class="big">PingTap — Retro Rally</div>
    <button id="startBtn" class="main">スタート</button>
  </div>
</div>

<div class="overlay" id="menu">
  <div class="panel">
    <h3 style="margin:0 0 10px">Pause</h3>
    <div class="row">
      <button class="btn" id="resumeBtn">▶ 再開</button>
      <button class="btn" id="restartBtn">↻ リスタート</button>
      <button class="btn" id="bgmBtn">♪ BGM ON/OFF</button>
    </div>
  </div>
</div>

<script>
/* ========= 可変パラメータ ========= */
const CFG = {
  TARGET_Y_FRAC: 0.56,        // ← リング（自分側）少し上
  ENEMY_Y_FRAC : 0.28,        // 相手側の高さ
  PLAYER_X_RANGE: 0.34,       // 自分側の左右ランダム幅
  ENEMY_X_RANGE : 0.42,       // 相手側の左右ランダム幅
  RING_PX      : 58,          // 初期リング半径
  DUR_MAX      : 1150,        // リング1周の最初の長さ(ms)
  DUR_MIN      : 460,         // 加速後の下限(ms)
  HITS_TO_MIN  : 60,          // この回数でDUR_MINに到達
  POST_90_STEP : 0.92,        // 90秒以降の鬼加速(ヒット毎に掛ける)
  ARC_FRAC     : 0.12,        // 放物線の高さ（画面高比）
  // タイミング判定（時間窓／durに対する割合）
  WIN_GOOD  : 0.18,
  WIN_GREAT : 0.11,
  WIN_PERF  : 0.065,
  SFX       : 0.35
};
/* ================================= */

const cv = document.getElementById('cv'), g = cv.getContext('2d');
let DPR=1, W=0, H=0; const $=sel=>document.getElementById(sel);
const scoreEl=$('score'), comboEl=$('combo'), pauseBtn=$('pause');
const center=$('center'), centerText=$('centerText'), startBtn=$('startBtn');
const menu=$('menu'), resumeBtn=$('resumeBtn'), restartBtn=$('restartBtn'), bgmBtn=$('bgmBtn');
const hint=$('hint'), ringEl=$('ring'), hintText=$('hintText');

let state='idle', raf=0, last=0, elapsed=0;
let score=0, combo=0, best=+(localStorage.getItem('pingtap_best')||0), level=1, hits=0, dur=CFG.DUR_MAX;
let ring={x:0,y:0,t:0,r:CFG.RING_PX}, ball=null, travel=null, after90=false;

function rs(){ DPR=Math.min(2,devicePixelRatio||1); W=cv.width=Math.floor(innerWidth*DPR); H=cv.height=Math.floor(innerHeight*DPR); cv.style.width=innerWidth+'px'; cv.style.height=innerHeight+'px'; }
addEventListener('resize', rs,{passive:true}); rs();

/* ---------- 音（簡易SFC風） ---------- */
const AC = new (window.AudioContext||window.webkitAudioContext)();
function sTap(kind='good'){ const t=AC.currentTime,v=AC.createGain(); v.gain.value=CFG.SFX; v.connect(AC.destination);
  const o=AC.createOscillator(); o.type='square'; const f=kind==='perfect'?880:(kind==='great'?740:660);
  o.frequency.setValueAtTime(f,t); o.frequency.exponentialRampToValueAtTime(f*0.7,t+0.06);
  v.gain.exponentialRampToValueAtTime(0.0001,t+0.08); o.connect(v); o.start(); o.stop(t+0.09);
}
function sMiss(){ const t=AC.currentTime,v=AC.createGain(); v.gain.value=CFG.SFX*0.9; v.connect(AC.destination);
  const a=AC.createOscillator(),b=AC.createOscillator(); a.type=b.type='triangle'; a.frequency.value=240; b.frequency.value=180;
  v.gain.exponentialRampToValueAtTime(0.0001,t+0.4); a.connect(v); b.connect(v); a.start(); b.start(); a.stop(t+0.41); b.stop(t+0.41);
}
let bgm=null; function startBGM(){ if(bgm) return; const m=AC.createGain(); m.gain.value=.18; m.connect(AC.destination);
  function line(type,seq,tempo){ const g=AC.createGain(); g.gain.value=0.8; g.connect(m); const o=AC.createOscillator(); o.type=type; o.connect(g);
    let t=AC.currentTime+.02, sp=60/tempo; for(let i=0;i<128;i++){ const n=seq[i%seq.length]; const f=440*Math.pow(2,(n-69)/12);
      o.frequency.setValueAtTime(f,t); g.gain.setValueAtTime(.9,t); g.gain.exponentialRampToValueAtTime(.001,t+sp*.8); t+=sp; } o.start(); return {o,g}; }
  const lead=line('square',[76,79,83,79,76,79,83,79],112), bass=line('triangle',[40,40,43,40,35,35,38,35],56);
  bgm={m,lead,bass};
}
function stopBGM(){ if(!bgm) return; try{bgm.lead.o.stop(); bgm.bass.o.stop();}catch{} bgm.m.disconnect(); bgm=null; }

/* ---------- ヘルパ ---------- */
function placeRing(){ const cx=innerWidth*.5;
  ring.x = cx + (Math.random()*2-1)*(innerWidth*CFG.PLAYER_X_RANGE*.5);
  ring.y = innerHeight*CFG.TARGET_Y_FRAC; ring.t=0; ring.r=CFG.RING_PX; showHint(true);
  ringEl.style.width=(ring.r*2)+'px'; ringEl.style.height=(ring.r*2)+'px';
}
function showHint(show){ if(!show){ hint.style.left='-9999px'; hint.style.top='-9999px'; return; } hint.style.left=ring.x+'px'; hint.style.top=ring.y+'px'; }
function updateHUD(){ scoreEl.textContent=`Score ${score|0}`; comboEl.textContent=`Combo ${combo|0}`; }

/* ---------- 返球スケジュール ---------- */
function scheduleEnemy(){ // 自分→相手→自分 の往復
  const sx=ring.x, sy=ring.y;
  const ex = innerWidth*.5 + (Math.random()*2-1)*(innerWidth*CFG.ENEMY_X_RANGE*.5);
  const ey = innerHeight*CFG.ENEMY_Y_FRAC;
  const nx= ring.x, ny= ring.y;
  const T1=Math.max(320, dur*0.58), T2=Math.max(320, dur*0.62);
  travel={phase:0,sx,sy,ex,ey,nx,ny,t:0,T1,T2};
  ball={x:sx,y:sy - innerHeight*0.22}; // 少し上から
}

function commit(grade){
  // スコア
  const base= grade==='perfect'?300 : grade==='great'?200 : 120;
  combo++; const mult = 1 + Math.min(2, combo*0.04); score += Math.round(base*mult);
  if(score>best){ best=score; localStorage.setItem('pingtap_best', best|0); }
  hits++; const p=Math.min(1, hits/CFG.HITS_TO_MIN);
  dur = CFG.DUR_MAX + (CFG.DUR_MIN-CFG.DUR_MAX)*p; // 緩やか加速
  if(elapsed>90000){ dur = Math.max(260, dur*CFG.POST_90_STEP); after90=true; } // 90秒以降は鬼加速
  level = 1 + Math.floor(hits/10);
  updateHUD(); sTap(grade);
  scheduleEnemy(); placeRing();
}

function miss(){
  sMiss(); state='over'; showHint(false); travel=null; ball=null; combo=0;
  center.style.display='grid'; centerText.textContent=`Score ${score|0} / Lv.${level|0}`; startBtn.textContent='もう一回';
}

/* ---------- ステート ---------- */
function resetAll(){
  cancelAnimationFrame(raf); raf=0; elapsed=0; state='idle';
  score=0; combo=0; hits=0; dur=CFG.DUR_MAX; level=1; after90=false; travel=null; ball=null;
  updateHUD(); centerText.textContent='PingTap — Retro Rally'; startBtn.textContent='スタート';
  showHint(false); placeRing(); draw();
}
function startGame(){ AC.resume().catch(()=>{}); center.style.display='none'; state='play'; last=performance.now(); showHint(true);
  if(!raf) raf=requestAnimationFrame(loop);
}

/* ---------- 入力 ---------- */
function tap(){
  if(state==='idle'||state==='over'){ resetAll(); startGame(); return; }
  if(state!=='play' || travel) return; // 飛行中は受付けない
  const ideal=dur*0.50, err=Math.abs(ring.t-ideal);
  let grade=null; if(err<=dur*CFG.WIN_PERF) grade='perfect'; else if(err<=dur*CFG.WIN_GREAT) grade='great'; else if(err<=dur*CFG.WIN_GOOD) grade='good';
  if(!grade) return miss();
  commit(grade);
}
addEventListener('pointerdown', e=>{ e.preventDefault(); tap(); }, {passive:false});

/* ---------- ループ ---------- */
function loop(t){ raf=requestAnimationFrame(loop); const dt=(t-last)||0; last=t; if(state!=='play'){ draw(); return; } elapsed+=dt; update(dt); draw(); }
function update(dt){
  // 待機中：リング縮小＆ボールふわふわ
  if(!travel){
    ring.t += dt;
    const p = Math.min(1, ring.t/dur);
    const r = CFG.RING_PX * (1-0.6*p);
    ring.r=r; ringEl.style.width=(r*2)+'px'; ringEl.style.height=(r*2)+'px';
    hintText.textContent = p<.35 ? 'TAP!' : 'HIT!';
    showHint(true);
    if(!ball){ ball={x:ring.x, y:ring.y - innerHeight*0.22}; }
    ball.y = ring.y - innerHeight*(0.22*(1-Math.min(1,p))); ball.x += (ring.x-ball.x)*0.15;
    if(ring.t > dur*(1+CFG.WIN_GOOD)) miss();
    return;
  }
  // 飛行中：相手へ→戻る の2フェーズ
  const T=travel;
  if(T.phase===0){
    T.t += dt; const u=Math.min(1, T.t/T.T1), v=u<.5?2*u*u:1-(( -2*u+2)**2)/2, h=innerHeight*CFG.ARC_FRAC;
    ball.x = T.sx + (T.ex-T.sx)*v;
    ball.y = (T.sy + (T.ey-T.sy)*v) - Math.sin(Math.PI*v)*h;
    if(u>=1){ T.phase=1; T.t=0; }
  }else{
    T.t += dt; const u=Math.min(1, T.t/T.T2), v=u<.5?2*u*u:1-(( -2*u+2)**2)/2, h=innerHeight*CFG.ARC_FRAC;
    ball.x = T.ex + (T.nx-T.ex)*v;
    ball.y = (T.ey + (T.ny-T.ey)*v) - Math.sin(Math.PI*v)*h;
    if(u>=1){ travel=null; ring.t=0; } // 自分側に着地 → 次の待機へ
  }
}
function draw(){
  g.clearRect(0,0,W,H);
  if(ball){ const r=8*DPR; g.fillStyle='#ffe07a'; g.beginPath(); g.arc(ball.x*DPR,ball.y*DPR,r,0,Math.PI*2); g.fill(); g.strokeStyle='rgba(0,0,0,.35)'; g.lineWidth=1*DPR; g.stroke(); }
}

/* ---------- ポーズ ---------- */
pauseBtn.addEventListener('click', ()=>{ if(state!=='play') return; state='pause'; menu.classList.add('show'); stopBGM(); });
resumeBtn.addEventListener('click', ()=>{ if(state!=='pause') return; menu.classList.remove('show'); state='play'; last=performance.now(); if(!raf) raf=requestAnimationFrame(loop); });
restartBtn.addEventListener('click', ()=>{ menu.classList.remove('show'); resetAll(); startGame(); });
bgmBtn.addEventListener('click', ()=>{ if(bgm) stopBGM(); else startBGM(); });
document.addEventListener('visibilitychange', ()=>{ if(document.hidden && state==='play') pauseBtn.click(); });

/* 初期化 */
resetAll();
</script>