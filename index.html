<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>PingTap — Retro Rally</title>

<!-- PWA（GitHub Pagesの公開パスに合わせて絶対パス） -->
<link rel="manifest" href="/pingtap-pages/manifest.webmanifest" />
<meta name="theme-color" content="#091427" />

<link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet" />
<style>
  :root{
    --hud-bg: rgba(20,20,30,.55);
    --ringP: rgba(255,235,150,.95);
    --ringO: rgba(170,220,255,.92);
    --accent:#ffd34d;
    --c-score:#FFE36E; --c-combo:#A8D6FF;
    --c-level:#FFFFFF;
  }
  html,body{margin:0;height:100%;background:#091427;color:#fff}
  body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif}
  #cv{position:fixed;inset:0;touch-action:manipulation}

  .hud{position:fixed;left:10px;right:10px;top:calc(10px + env(safe-area-inset-top,0px));
       display:grid;grid-template-columns:1fr 1fr;gap:10px;z-index:9;pointer-events:none}
  .pill{min-width:0;background:var(--hud-bg);backdrop-filter: blur(2px);
        border-radius:18px;padding:10px 14px;font-weight:900;letter-spacing:.2px}
  .pill b{display:block;font:700 18px "DotGothic16",system-ui}
  .pill small{opacity:.95;font:700 15px "DotGothic16",system-ui}
  #sc{color:var(--c-score)} #cm{color:var(--c-combo)}
  .wide{grid-column:1 / span 2; text-align:center}
  .wide b{color:var(--c-level)}

  .card{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
        background:
          radial-gradient(120% 90% at 50% 30%, rgba(255,200,120,.20), rgba(0,0,0,.55) 70%),
          rgba(0,0,0,.50);
        backdrop-filter: blur(2px) saturate(1.15);
        border-radius:22px; text-align:center;padding:18px;z-index:10;
        box-shadow:0 12px 28px rgba(0,0,0,.45),
                   inset 0 0 0 2px rgba(255,230,140,.18),
                   inset 0 0 18px rgba(255,210,120,.15)}
  .card::before,.card::after{content:"";position:absolute;inset:0;border-radius:22px;pointer-events:none}
  .card::before{background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.055) 0 1px, rgba(0,0,0,.055) 1px 2px);
      mix-blend-mode:overlay;opacity:.35;animation:flicker 6s linear infinite}
  .card::after{background:
      radial-gradient(140% 80% at 50% 120%, rgba(0,0,0,.45), transparent 55%),
      radial-gradient(130% 80% at -10% -10%, rgba(255,220,140,.15), transparent 35%),
      radial-gradient(130% 80% at 110% -10%, rgba(150,210,255,.10), transparent 35%)}
  @keyframes flicker{0%,100%{opacity:.35}45%{opacity:.28}52%{opacity:.38}70%{opacity:.30}}

  .title{
    font:700 clamp(28px,5.6vw,44px) "DotGothic16",system-ui;
    color:#ffe8a8; letter-spacing:.6px;
    text-shadow:
      0  1px 0 #000, 0 -1px 0 #000,  1px 0 0 #000, -1px 0 0 #000,
      1px 1px 0 #000, -1px 1px 0 #000, 1px -1px 0 #000, -1px -1px 0 #000,
      0 3px 0 #8c5b00, 0 8px 18px rgba(255,210,120,.35);
  }
  .lead{color:#ffe6bf;text-shadow:0 2px 0 rgba(0,0,0,.55),0 0 10px rgba(255,220,140,.25)}
  .desc{color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.6),0 0 8px rgba(0,0,0,.35)}
  #bestInfo{color:#ffd34d;font-weight:900;letter-spacing:.4px;
            text-shadow:0 1px 0 #5a3a00,0 0 10px rgba(255,211,77,.45)}
  .btn{background:#ffd34d;box-shadow:0 6px 0 #caa132,0 14px 24px rgba(255,200,80,.28);
       display:inline-grid;place-items:center;min-width:46px;height:46px;border-radius:18px;
       padding:0 18px;color:#222;font-weight:900;font-size:18px;border:0;animation:pulse 1.6s ease-in-out infinite}
  @keyframes pulse{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-1px) scale(1.02)}}

  .judge{position:fixed;left:0;top:0;pointer-events:none;z-index:8;
         font:700 16px "DotGothic16",system-ui;text-shadow:0 2px 0 rgba(0,0,0,.55)}

  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .txt{font:700 18px 'DotGothic16',system-ui;padding:10px 12px;border-radius:14px;border:0;outline:0;width:min(360px,80%);text-align:center}
  .btn.secondary{background:#b9ffa8;box-shadow:0 6px 0 #7bc674}
</style>

<canvas id="cv"></canvas>

<div class="hud">
  <div class="pill"><b id="sc">Score 0</b><small id="scsub">&nbsp;</small></div>
  <div class="pill"><b id="cm">Combo 0</b><small id="cmsub">&nbsp;</small></div>
  <div class="pill wide"><b id="lvline">Lv.1　0:00</b></div>
</div>

<div class="card" id="start">
  <div class="title">レッツ！ピンポン！！</div>
  <div class="lead">ラリーを楽しもう</div>
  <div class="desc">円が重なる瞬間に <b>TAP!</b></div>
  <div class="desc" style="margin-bottom:12px">Perfect / Great / Good で加点＆コンボ。<br>90秒で<strong>激ムズ</strong>モード。</div>
  <div class="desc" id="bestInfo" style="margin-bottom:14px"></div>
  <div class="row" style="margin-bottom:10px">
    <!-- 通常はJSのイベント配線。念のため inline 保険も併用 -->
    <button id="go" class="btn" onclick="window.__pingtap_go && window.__pingtap_go()">スタート</button>
    <button id="seeRank" class="btn secondary" onclick="window.__pingtap_rank && window.__pingtap_rank()">ランキング</button>
  </div>
</div>

<!-- 初回ニックネーム -->
<div class="card" id="namecard" style="display:none">
  <div class="title" style="font-size:28px">名前を決めよう</div>
  <div class="desc" style="margin-bottom:10px">PGSのランキング名はGoogleのゲーマータグ。<br>ここはゲーム内の表示用ニックネーム。</div>
  <input id="nameinp" class="txt" maxlength="16" placeholder="例：よう">
  <div class="row" style="margin-top:8px">
    <button id="nameset" class="btn">決定</button>
  </div>
</div>

<div class="card" id="over" style="display:none">
  <div id="final" class="title" style="font-size:28px">Score 0<br>Lv.1</div>
  <div class="row" style="margin-top:10px">
    <button id="retry" class="btn">もう一回</button>
    <button id="rank2" class="btn secondary">ランキング</button>
  </div>
</div>

<div id="judge" class="judge" style="display:none">TAP!</div>

<!-- ==== クリックが死んだときの最小限の保険 ==== -->
<script>
window.__pingtap_go = () => {
  if (!localStorage.getItem('PT_name')) {
    const c=document.getElementById('namecard'), i=document.getElementById('nameinp');
    if(c) c.style.display='flex'; if(i){ i.value=''; i.focus(); }
    return;
  }
  if (window.startGame) window.startGame();
};
window.__pingtap_rank = () => {
  try{
    if (window.AndroidBridge?.showLeaderboard2) {
      window.AndroidBridge.showLeaderboard2('PGS_LEADERBOARD_ID_HERE');
    } else if (window.AndroidBridge?.showLeaderboard) {
      window.AndroidBridge.showLeaderboard();
    }
  }catch(_){}
};
</script>

<script>
(()=>{
// ===== ブリッジ（WebではNO-OP） =====
const LEADERBOARD_ID="PGS_LEADERBOARD_ID_HERE";
const Native=(()=>{const A=window.AndroidBridge||null;return{
  submitScore(s){try{if(!A)return;if(typeof A.submitScore2==='function')A.submitScore2(s|0,LEADERBOARD_ID);else if(typeof A.submitScore==='function')A.submitScore(s|0);}catch(_){}},
  showBoard(){try{if(!A)return;if(typeof A.showLeaderboard2==='function')A.showLeaderboard2(LEADERBOARD_ID);else if(typeof A.showLeaderboard==='function')A.showLeaderboard();}catch(_){}},
  showAd(r){try{A?.showAd?.(String(r||''));}catch(_){}}
}})();

// ===== 画像（リポの実ファイル名） =====
const BG_URL='./F0BDAD6E-3A4B-49E8-86BF-73CE3EAA6C58.png';
const FG_URL='./IMG_4465.png';
const OPP_IDLE='./IMG_4414.png';
const OPP_SWING='./IMG_4413.png';
const OPP_FOLLOW='./IMG_4412.png';

// ===== パラメータ（台の見え方は据え置き） =====
const NET_Y=0.595, Y_PLAYER=0.115, Y_OPP=0.085, X_MARGIN=0.16, Y_JIT=0.018;
const START_DUR=1.00, SPEEDUP_EVERY=1, SPEEDUP_RATE=0.92, MIN_DUR=0.52, DEMON_AT=90;
const FLOOR_RAMP_START=5, FLOOR_RAMP_END=90, PRE_DEMON_FLOOR=0.24, DEMON_FLOOR=0.18;
const RING_BASE=28, RING_SHRINK=36;
const TOL_DIST_GOOD=36, TOL_DIST_GREAT=22, TOL_DIST_PERF=12;
const TOL_TIME_GOOD=12, TOL_TIME_GREAT=7, TOL_TIME_PERF=3;
const SCORE_BASE=100, MULT_GOOD=1.00, MULT_GREAT=1.30, MULT_PERF=1.60;
const COMBO_BONUS=0.15;
const ARC_H=0.12, CURVE_X=0.10;
const BG_DES_W=768, BG_DES_H=1152;
/* 台 */
let FG_SCALE=0.82, FG_Y_OFFSET=0;
const OPP_BASE_SCALE=0.58*1.35, OPP_FOOT_Y=0.565;
const BALL_FRONT=true;

// ===== DOM / 状態 =====
const cv=document.getElementById('cv'), g=cv.getContext('2d');
const S=document.getElementById('start'), O=document.getElementById('over');
const go=document.getElementById('go'), retry=document.getElementById('retry');
const F=document.getElementById('final'), judgeEl=document.getElementById('judge');
const sc=document.getElementById('sc'), scs=document.getElementById('scsub');
const cm=document.getElementById('cm'), cms=document.getElementById('cmsub');
const lvline=document.getElementById('lvline'), bestInfo=document.getElementById('bestInfo');
const nameCard=document.getElementById('namecard'), nameInp=document.getElementById('nameinp'), nameSet=document.getElementById('nameset');
const btnSeeRank=document.getElementById('seeRank'), btnRank2=document.getElementById('rank2');

let W=0,H=0,dpr=1;
function fit(){ dpr=Math.max(1,Math.min(2,devicePixelRatio||1));
  W=innerWidth; H=innerHeight;
  cv.width=W*dpr; cv.height=H*dpr; cv.style.width=W+'px'; cv.style.height=H+'px';
  g.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize',fit,{passive:true}); fit();

function load(src){return new Promise(r=>{const i=new Image(); i.crossOrigin='anonymous';
  i.onload=()=>r(i); i.onerror=()=>r(null); i.src=src; });}
const A={bg:null,fg:null,oppIdle:null,oppSw:null,oppFo:null};
let netBandNorm=null;

Promise.all([load(BG_URL),load(FG_URL),load(OPP_IDLE),load(OPP_SWING),load(OPP_FOLLOW)])
  .then(([a,b,c,d,e])=>{A.bg=a;A.fg=b;A.oppIdle=c;A.oppSw=d;A.oppFo=e;if(b)detectNetBand(b);});

// ===== ネット帯検出 =====
function detectNetBand(img){
  const iw=img.width, ih=img.height;
  const off=document.createElement('canvas'); off.width=iw; off.height=ih;
  const ctx=off.getContext('2d'); ctx.drawImage(img,0,0);
  const data=ctx.getImageData(0,0,iw,ih).data;
  const xL=Math.floor(iw*0.08), xR=Math.floor(iw*0.92);
  let yTopObj=ih, yBotObj=0;
  for(let y=0;y<ih;y++){
    let has=false;
    for(let x=xL;x<=xR;x+=2){
      if(data[(y*iw+x)*4+3]>16){ has=true; break; }
    }
    if(has){ yTopObj=Math.min(yTopObj,y); yBotObj=Math.max(yBotObj,y); }
  }
  if(yTopObj>=yBotObj){ netBandNorm={x:0.045,y:0.472,w:0.91,h:0.115}; return; }
  const yA=yTopObj, yB=Math.floor(yTopObj+(yBotObj-yTopObj)*0.35);
  const transRatio=new Float32Array(ih).fill(0);
  for(let y=yA;y<=yB;y++){
    let L=-1,R=-1;
    for(let x=xL;x<=xR;x++){ if(data[(y*iw+x)*4+3]>16){ L=x; break; } }
    for(let x=xR;x>=xL;x--){ if(data[(y*iw+x)*4+3]>16){ R=x; break; } }
    if(L>=0&&R>L){
      let tot=0,hole=0;
      for(let x=L;x<=R;x++){ const a=data[(y*iw+x)*4+3]; if(a<=16) hole++; tot++; }
      transRatio[y]=hole/Math.max(1,tot);
    }
  }
  let yPeak=yA,vPeak=0;
  for(let y=yA;y<=yB;y++) if(transRatio[y]>vPeak){vPeak=transRatio[y]; yPeak=y;}
  if(vPeak<0.1){ netBandNorm={x:0.045,y:0.472,w:0.91,h:0.115}; return; }
  const thr=vPeak*0.45; let y1=yPeak,y2=yPeak;
  while(y1>yA&&transRatio[y1-1]>thr)y1--;
  while(y2<yB&&transRatio[y2+1]>thr)y2++;
  const rx=Math.floor(iw*0.05), rw=Math.floor(iw*0.90);
  const ry=Math.max(0,y1-2), rh=Math.min(ih-ry,(y2-y1)+4);
  netBandNorm={x:rx/iw,y:ry/ih,w:rw/iw,h:rh/ih};
}

// ===== オーディオ =====
let AC=null, master=null, bgm={timer:null,lead:null,bass:null,lg:null,bg:null};
function ac(){ if(!AC){ AC=new (window.AudioContext||window.webkitAudioContext)();
  master=AC.createGain(); master.gain.value=.9; master.connect(AC.destination); }
  if(AC.state!=='running'){ AC.resume(); } }
function sePock(){ ac();
  const o=AC.createOscillator(), g1=AC.createGain();
  o.type='sine'; o.frequency.setValueAtTime(1350,AC.currentTime);
  o.frequency.exponentialRampToValueAtTime(520,AC.currentTime+0.06);
  g1.gain.setValueAtTime(0.0001,AC.currentTime);
  g1.gain.exponentialRampToValueAtTime(0.35,AC.currentTime+0.005);
  g1.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+0.12);
  o.connect(g1).connect(master); o.start(); o.stop(AC.currentTime+0.14);
  const buf=AC.createBuffer(1,AC.sampleRate*0.07,AC.sampleRate), ch=buf.getChannelData(0);
  for(let i=0;i<ch.length;i++) ch[i]=(Math.random()*2-1)*Math.pow(1-i/ch.length,2);
  const n=AC.createBufferSource(); n.buffer=buf; const g2=AC.createGain(); g2.gain.value=0.12;
  n.connect(g2).connect(master); n.start(); n.stop(AC.currentTime+0.07);
}

// ===== 乱数・スポット =====
const R=Math.random, rnd=(a,b)=>a+R()*(b-a), sec=()=>performance.now()/1000;
const oppSpot=()=>({x:rnd(W*X_MARGIN,W*(1-X_MARGIN)), y:H*NET_Y-H*Y_OPP+rnd(-H*Y_JIT,H*Y_JIT)});
const plySpot=()=>({x:rnd(W*X_MARGIN,W*(1-X_MARGIN)), y:H*NET_Y+H*Y_PLAYER+rnd(-H*Y_JIT,H*Y_JIT)});

let playing=false, t0=0, dur=START_DUR, phase='toPlayer';
let from={x:0,y:0}, to={x:0,y:0}, ctrl={x:0,y:0};
let playerAim={x:0,y:0}, oppAim={x:0,y:0};
let score=0, combo=0, best=Number(localStorage.getItem('PT_best')||0), level=1, steps=0, startedAt=0;
let judgeText='', judgeUntil=0, judgeColor='#ffe38a';
bestInfo.textContent='Best '+best.toFixed(0);
let _playCount=0;
const Name={ get:()=>localStorage.getItem('PT_name')||'', set:n=>localStorage.setItem('PT_name',(n||'Guest').trim().slice(0,16)) };

const bez=(p,a,c,b)=>{const u=1-p; return u*u*a+2*u*p*c+p*p*b;}
function setLeg(a,b){ from=a;to=b;t0=sec();
  const midx=(a.x+b.x)/2, curve=(b.x-a.x)*rnd(-CURVE_X,CURVE_X);
  ctrl={x:midx+curve, y:H*NET_Y - H*ARC_H*rnd(0.85,1.15)};
}
function fmtTime(v){ const s=Math.max(0,Math.floor(v)); return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
function updateLvTime(){ lvline.textContent = `Lv.${level}　${fmtTime(sec()-startedAt)}`; }
function showJudge(text,color,x,y){
  judgeText=text; judgeColor=color; judgeUntil=sec()+0.85;
  judgeEl.style.display='block'; judgeEl.textContent=text; judgeEl.style.color=color;
  judgeEl.style.left = (x-9999)+'px';
}

function currentMinDur(){
  const t = sec() - startedAt;
  if (t <= FLOOR_RAMP_START) return MIN_DUR;
  if (t < FLOOR_RAMP_END) {
    const u = (t - FLOOR_RAMP_START) / (FLOOR_RAMP_END - FLOOR_RAMP_START);
    return MIN_DUR - (MIN_DUR - PRE_DEMON_FLOOR) * Math.min(1, Math.max(0, u));
  }
  const u2 = Math.min(1, (t - FLOOR_RAMP_END) / 30);
  return PRE_DEMON_FLOOR - (PRE_DEMON_FLOOR - DEMON_FLOOR) * u2;
}

function resetState(){
  score=0;combo=0;level=1;steps=0;dur=START_DUR;
  sc.textContent='Score 0';scs.innerHTML='&nbsp;';cm.textContent='Combo 0';cms.innerHTML='&nbsp;';
  playerAim=plySpot(); oppAim=oppSpot(); phase='toPlayer'; startedAt=sec();
  updateLvTime();
  setLeg(oppAim,playerAim); judgeUntil=0; judgeEl.style.display='none';
}
function startGame(){ ac(); stopBGM(); startBGM(); resetState(); S.style.display='none'; O.style.display='none'; playing=true; }
window.startGame = startGame; // inline保険用

function pauseGame(){ if(playing) playing=false; stopBGM(); }
function resumeGame(){ if(!playing && S.style.display==='none' && O.style.display==='none'){ startBGM(); playing=true; } }
window.__pingtap = Object.assign(window.__pingtap||{}, { pause:pauseGame, resume:resumeGame });

function gameOver(){
  playing=false; stopBGM();
  if(score>best){best=score;localStorage.setItem('PT_best',best); bestInfo.textContent='Best '+best.toFixed(0); }
  F.innerHTML='Score '+score.toFixed(0)+'<br>Lv.'+level;
  Native.submitScore(Math.floor(score));
  _playCount++; if((_playCount % 2) === 0){ pauseGame(); Native.showAd('post_game'); }
  O.style.display='flex';
}

// ===== 入力 =====
addEventListener('pointerdown', e=>{
  ac();
  if(!playing||phase!=='toPlayer') return;
  const r=cv.getBoundingClientRect(); const x=(e.clientX??e.touches?.[0]?.clientX)-r.left;
  const y=(e.clientY??e.touches?.[0]?.clientY)-r.top;
  const rr=ringRadiusNow(), dt=Math.abs(rr-RING_BASE), d=Math.hypot(x-playerAim.x,y-playerAim.y);
  let mult=0, tag='', col='#ffe38a';
  if(dt<=TOL_TIME_PERF && d<=TOL_DIST_PERF){mult=MULT_PERF;tag='PERFECT!';col='#ff6b6b';}
  else if(dt<=TOL_TIME_GREAT && d<=TOL_DIST_GREAT){mult=MULT_GREAT;tag='GREAT!';col='#7cd1ff';}
  else if(dt<=TOL_TIME_GOOD && d<=TOL_DIST_GOOD){mult=MULT_GOOD;tag='GOOD!'; col='#ffe38a';}
  if(mult>0){
    sePock();
    const add=Math.round(SCORE_BASE*mult*(1+combo*COMBO_BONUS));
    score+=add;combo++;steps++;sc.textContent='Score '+score.toFixed(0);scs.textContent='+'+add;
    cm.textContent='Combo '+combo;cms.textContent=tag;
    showJudge(tag,col,playerAim.x,playerAim.y-RING_BASE-12);

    if(steps%SPEEDUP_EVERY===0){
      let rate=SPEEDUP_RATE;
      if ((sec()-startedAt) >= DEMON_AT) rate*=0.85;
      dur=Math.max(currentMinDur(), dur*rate);
      level++; updateLvTime();
    }

    phase='toOpponent'; oppAim=oppSpot(); setLeg(playerAim,oppAim);
  }else{ cms.textContent='Miss!'; showJudge('MISS!','#ffb3b3',playerAim.x,playerAim.y-RING_BASE-12); gameOver(); }
},{passive:true});
function ringRadiusNow(){ const p=Math.min(1,Math.max(0,(sec()-t0)/dur)); return RING_BASE+RING_SHRINK*((phase==='toPlayer')?(1-p):1); }

// ===== ループ =====
function loop(){
  const now=sec();

  if(A.bg){ const r=Math.max(W/A.bg.width,H/A.bg.height), w=A.bg.width*r, h=A.bg.height*r;
    g.drawImage(A.bg,(W-w)/2,(H-h)/2,w,h);
  }else{ const grad=g.createLinearGradient(0,0,0,H); grad.addColorStop(0,'#1a315d'); grad.addColorStop(1,'#0b1631'); g.fillStyle=grad; g.fillRect(0,0,W,H); }

  drawOpponent(now);
  drawForegroundWithBand();

  if(playing){
    const p=Math.min(1,(now-t0)/dur);
    const bx=bez(p,from.x,ctrl.x,to.x), by=bez(p,from.y,ctrl.y,to.y);
    if(phase==='toOpponent' && p>0.64 && p<0.66){ sePock(); }
    if(p>=1){ if(phase==='toPlayer'){ gameOver(); } else { phase='toPlayer'; playerAim=plySpot(); setLeg(oppAim,playerAim); } }

    const rr=ringRadiusNow();
    drawGuide(playerAim.x,playerAim.y,rr,true,(judgeUntil>now)?judgeText:'TAP!', judgeColor);

    if(BALL_FRONT){
      const hNorm=1-4*(p-0.5)*(p-0.5), rad=8*(1+0.08*hNorm);
      g.globalAlpha=0.25*(1-hNorm); g.fillStyle='#000';
      g.beginPath(); g.ellipse(bx+2,by+6,rad*0.9,rad*0.55,0,0,Math.PI*2); g.fill();
      g.globalAlpha=1; g.fillStyle='#fff'; g.beginPath(); g.arc(bx,by,rad,0,Math.PI*2); g.fill();
    }
    updateLvTime();
  }

  if(playing && (now-startedAt)>=DEMON_AT){ g.fillStyle='rgba(255,80,80,.18)'; g.fillRect(0,0,W,6); }

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// ===== 前景（ネット帯白塗り→PNG） =====
function drawForegroundWithBand(){
  if(!A.fg) return;
  const sBase=Math.min(W/BG_DES_W,H/BG_DES_H), s=sBase*FG_SCALE;
  const fw=A.fg.width*s, fh=A.fg.height*s;
  const fx=Math.round((W-fw)/2);
  const fy=Math.round(H - fh + FG_Y_OFFSET*s);
  const nb=netBandNorm || {x:0.045,y:0.472,w:0.91,h:0.115};
  const bx=Math.round(fx+nb.x*fw), by=Math.round(fy+nb.y*fh);
  const bw=Math.round(nb.w*fw),  bh=Math.round(nb.h*fh);
  g.fillStyle='#fff'; g.fillRect(bx,by,bw,bh);
  const keep=g.imageSmoothingEnabled; g.imageSmoothingEnabled=false;
  g.drawImage(A.fg,fx,fy,fw,fh); g.imageSmoothingEnabled=keep;
}

// ===== 相手 =====
function drawOpponent(now){
  if(!A.oppIdle) return;
  const sBase=Math.min(W/BG_DES_W,H/BG_DES_H), scale=sBase*OPP_BASE_SCALE;
  const idle=A.oppIdle, sw=A.oppSw, fo=A.oppFo; let img=idle;
  if(playing && phase==='toOpponent'){ const p=Math.min(1,(now-t0)/dur); if(p>0.65&&p<=0.8)img=sw; else if(p>0.8&&p<=0.95)img=fo; }
  let cx, faceRight; if(playing){ cx=oppAim.x; faceRight=(oppAim.x < W*0.5); } else { cx=W*0.5; faceRight=true; }
  const iw=img.width*scale, ih=img.height*scale; const x=cx - iw*0.5, y=H*OPP_FOOT_Y - ih;
  g.save(); if(!faceRight){ g.translate(cx,0); g.scale(-1,1); g.translate(-cx,0); }
  const keep=g.imageSmoothingEnabled; g.imageSmoothingEnabled=false;
  g.drawImage(img, faceRight?x:(2*cx - x - iw), Math.round(y), Math.round(iw), Math.round(ih));
  g.imageSmoothingEnabled=keep; g.restore();
}

// ===== UI配線 =====
const NameAPI={ get:()=>localStorage.getItem('PT_name')||'', set:v=>localStorage.setItem('PT_name',(v||'Guest').trim().slice(0,16)) };
function ensureName(){ const has=!!NameAPI.get(); nameCard.style.display=has?'none':'flex'; if(!has){ nameInp.value=''; nameInp.focus(); } return has; }
go.addEventListener('click', ()=>{ ensureName()?startGame():null; });
retry.addEventListener('click', ()=>{ S.style.display='flex'; O.style.display='none'; });
btnSeeRank.addEventListener('click', ()=>{ Native.showBoard(); });
btnRank2.addEventListener('click', ()=>{ Native.showBoard(); });
nameSet.addEventListener('click', ()=>{ const v=(nameInp.value||'').trim(); if(!v){ alert('名前を入力してね'); return; } NameAPI.set(v); nameCard.style.display='none'; });
document.addEventListener('DOMContentLoaded', ()=>{ ensureName(); });

// バックグラウンドでのポーズ/レジューム
document.addEventListener('visibilitychange', ()=>{ document.hidden ? pauseGame() : resumeGame(); });

// ==== BGM（最後に定義） ====
function startBGM(){ ac(); stopBGM();
  const leadSeq=[0,2,4,5,7,5,4,2]; const baseA=440, bassDiv=4, tempo=124, stepMs=60000/tempo/2;
  bgm.lead=AC.createOscillator(); bgm.lg=AC.createGain();
  bgm.bass=AC.createOscillator(); bgm.bg=AC.createGain();
  bgm.lead.type='square'; bgm.bass.type='triangle';
  bgm.lg.gain.value=0.06; bgm.bg.gain.value=0.05;
  bgm.lead.connect(bgm.lg).connect(master); bgm.bass.connect(bgm.bg).connect(master);
  bgm.lead.start(); bgm.bass.start();
  let k=0; bgm.timer=setInterval(()=>{ if(AC.state!=='running') AC.resume();
    const deg=leadSeq[k%leadSeq.length];
    bgm.lead.frequency.setValueAtTime(baseA*Math.pow(2,deg/12), AC.currentTime);
    bgm.bass.frequency.setValueAtTime((baseA/bassDiv)*Math.pow(2,((k%4)*2)/12), AC.currentTime);
    k++;
  }, stepMs);
}
function stopBGM(){ if(bgm.timer){ clearInterval(bgm.timer); bgm.timer=null; }
  ['lead','bass','lg','bg'].forEach(n=>{ if(bgm[n]){ try{bgm[n].stop()}catch{} try{bgm[n].disconnect()}catch{} bgm[n]=null; }});
}
})();</script>

<!-- PWA: Service Worker（絶対パス/即時更新） -->
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/pingtap-pages/sw.js')
    .then(reg=>{ try{reg.update();}catch(_){} })
    .catch(()=>{});
}
</script>
</html>